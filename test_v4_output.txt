C:\Users\milan\Desktop\Git-Projects\ml_trading_system\modules\regime_detector.py:43: UserWarning: hmmlearn not available. HMM detection will not work. Install with: pip install hmmlearn
  warnings.warn("hmmlearn not available. HMM detection will not work. Install with: pip install hmmlearn")
[INFO] Initialized SentimentCollector
[INFO]   Cache directory: data\sentiment_cache
[INFO] Downloading Fear & Greed Index...
[INFO]   Loading from cache: fear_greed_2021-10-31_2025-10-30.csv
[INFO] Downloading VIX data...
[INFO]   Loading from cache: vix_2021-10-31_2025-10-30.csv
[INFO] Downloading Bitcoin data...
[INFO]   Loading from cache: btc_2021-10-31_2025-10-30.csv
[INFO] 
Merging sentiment data...
[INFO] Merged sentiment data: 1461 rows, 8 columns
[INFO] Initialized FeatureEngineer
[INFO] Creating all basic features...
[INFO] Creating return features...
[INFO] Created 4 return features
[INFO] Creating volatility features...
[INFO] Created 2 volatility features
[INFO] Creating volume features...
[INFO] Created 1 volume feature
[INFO] Creating price position feature...
[INFO] Created 1 price position feature
[INFO] Creating trend features...
[INFO] Created 3 trend features
[INFO] Created 11 features total
[INFO] Initialized SentimentFeatureEngineer
[INFO] Creating Fear & Greed features...
[INFO]   Created 5 Fear & Greed features
[INFO] Creating VIX features...
[INFO]   Created 5 VIX features
[INFO] Creating Bitcoin features...
C:\Users\milan\Desktop\Git-Projects\ml_trading_system\sentiment_features.py:186: FutureWarning: The default fill_method='pad' in Series.pct_change is deprecated and will be removed in a future version. Either fill in any non-leading NA values prior to calling pct_change or specify 'fill_method=None' to not fill NA values.
  btc_returns = btc_close.pct_change()
[INFO]   Created 4 Bitcoin features
[INFO] Creating composite sentiment score...
[INFO]   Created composite sentiment score
[INFO]   Mean: 0.143, Std: 0.392
[INFO] 
Handling missing values...
[INFO]   Missing values: 23 \u2192 0
[INFO] 
Detecting regimes using RULE-BASED method...
[INFO] 
RULE-BASED Regime Distribution:
[INFO]   BULL      :  642 days ( 63.9%) - Position size: 50%
[INFO]   SIDEWAYS  :   43 days (  4.3%) - Position size: 25%
[INFO]   BEAR      :  299 days ( 29.8%) - Position size: 0%
[INFO]   CRISIS    :   20 days (  2.0%) - Position size: 0%
[INFO] Initialized XGBoostModel
[INFO]   max_depth: 4
[INFO]   learning_rate: 0.1
[INFO]   n_estimators: 100
[INFO] Training XGBoost model...
[INFO]   Using validation set for early stopping
[INFO]   Best iteration: 0
[INFO] Training metrics:
[INFO]   Train R\xb2: 0.0738
[INFO]   Train MSE: 0.000599
[INFO]   Val R\xb2: -0.0354
[INFO]   Val MSE: 0.000382
[WARNING]   \u26a0\ufe0f Possible overfitting detected! Train-Val gap: 0.1092
[WARNING]      Consider: decrease max_depth, increase min_child_weight
[INFO] Initialized Backtester:
[INFO]   Initial capital: $10,000
[INFO]   Transaction cost: 0.10%
[INFO]   Holding period: 5 days
[INFO]   Position size: 50%
[INFO] Running backtest simulation...
[INFO] Simulating 282 trading days...
[INFO] Closing 3 remaining positions...
[INFO] \u2713 Backtest complete:
[INFO]   Total trades: 172
[INFO]   Transaction costs: $1031.63
[INFO]   Final equity: $10,786.41
[INFO]   Total return: 7.86%
[INFO] Initialized Backtester:
[INFO]   Initial capital: $10,000
[INFO]   Transaction cost: 0.10%
[INFO]   Holding period: 5 days
[INFO]   Position size: 50%
[INFO] Running backtest simulation...
[INFO] Simulating 282 trading days...
[INFO] Closing 3 remaining positions...
[INFO] \u2713 Backtest complete:
[INFO]   Total trades: 152
[INFO]   Transaction costs: $913.32
[INFO]   Final equity: $10,609.98
[INFO]   Total return: 6.10%
======================================================================
TEST #4 - WITH MARKET REGIME DETECTION
======================================================================
Date: 2025-10-30 16:15:49
Strategy: Retrain model when market regime changes
======================================================================

[STEP 1/6] DOWNLOADING FRESH DATA
======================================================================
SPY data: 1004 days

======================================================================
COLLECTING SENTIMENT DATA
======================================================================
Date range: 2021-10-31 to 2025-10-30


======================================================================
SENTIMENT DATA COLLECTED
======================================================================
Total rows: 1461
Total columns: 8
Date range: 2021-10-31 to 2025-10-30

Columns:
  - fear_greed_value
  - fear_greed_classification
  - VIX
  - BTC_Close
  - BTC_Volume
  - BTC_return_1d
  - BTC_return_5d
  - BTC_return_10d
======================================================================

[STEP 2/6] CREATING FEATURES
======================================================================

======================================================================
CREATING SENTIMENT FEATURES
======================================================================

======================================================================
SENTIMENT FEATURES COMPLETE
======================================================================
Total features: 15
Total rows: 1004

Feature list:
   1. fear_greed_ma5
   2. fear_greed_ma10
   3. fear_greed_extreme_fear
   4. fear_greed_extreme_greed
   5. fear_greed_change_5d
   6. vix_ma5
   7. vix_ma20
   8. vix_regime
   9. vix_spike
  10. vix_zscore
  11. btc_return_5d
  12. btc_return_10d
  13. btc_volatility_10d
  14. btc_momentum
  15. composite_sentiment
======================================================================
Total features: 28
Period: 2022-01-27 to 2025-10-23

[STEP 3/6] DETECTING MARKET REGIMES
======================================================================

Regime Distribution:
  BULL        :  619 days ( 65.9%)
  BEAR        :  275 days ( 29.3%)
  SIDEWAYS    :   25 days (  2.7%)
  CRISIS      :   20 days (  2.1%)

[STEP 4/6] IDENTIFYING REGIME CHANGES
======================================================================
Total regime changes: 28

Major regime changes:
  2022-03-28: BEAR -> SIDEWAYS
  2022-03-31: SIDEWAYS -> BEAR
  2022-04-04: BEAR -> BULL
  2022-04-05: BULL -> BEAR
  2022-11-30: BEAR -> SIDEWAYS
  2022-12-05: SIDEWAYS -> BEAR
  2023-01-13: BEAR -> BULL
  2023-01-18: BULL -> BEAR
  2023-01-23: BEAR -> BULL
  2023-03-09: BULL -> BEAR

[STEP 5/6] SPLITTING DATA
======================================================================
Train: 657 days (2022-01-27 to 2024-09-09)
Test:  282 days (2024-09-10 to 2025-10-23)

Test period regimes:
  BULL        :  235 days ( 83.3%)
  BEAR        :   22 days (  7.8%)
  CRISIS      :   20 days (  7.1%)
  SIDEWAYS    :    5 days (  1.8%)

[STEP 6/6] BACKTESTING WITH REGIME AWARENESS
======================================================================

Training BASELINE model (no regime awareness)...

Running baseline backtest...


Training REGIME-AWARE model...
Strategy: Adjust position size based on regime

Running regime-aware backtest...

======================================================================
FINAL RESULTS - REGIME AWARENESS COMPARISON
======================================================================

[BASELINE - No Regime Detection]
  Total Return:       7.86%
  Sharpe Ratio:       0.61
  Max Drawdown:     -16.92%
  Total Trades:        172
  Win Rate:           62.8%

[REGIME-AWARE - With Market Regime Detection]
  Total Return:       6.10%
  Sharpe Ratio:       0.63
  Max Drawdown:     -10.31%
  Total Trades:        152
  Win Rate:           60.5%

======================================================================
COMPARISON WITH ALL TESTS
======================================================================
Test #1 (WITH VIX/BTC):              Sharpe 0.61, 172 trades
Test #2 (NO VIX/BTC):                Sharpe 0.55, 101 trades
Test #3 (REFERENCE on fresh):        Sharpe 0.78, 1 trade
Test #4 (BASELINE):                  Sharpe 0.61, 172 trades
Test #4 (WITH REGIME DETECTION):    Sharpe 0.63, 152 trades

======================================================================
CONCLUSION:
======================================================================
Regime detection IMPROVES performance!
  Sharpe improvement: 0.01
  But provides BETTER drawdown protection!
======================================================================
